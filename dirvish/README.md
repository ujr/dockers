# Docker image for Dirvish

[Dirvish][dirvish] is a simple Unix backup solution,
written in Perl, using **rsync** and **ssh**, and
exploiting the hardlink feature of Unix file systems
for simple deduplication.

We have successfully used dirvish for years to backup
Linux servers. However, we have found it more reliable
to do the backup in two stages:

1. mirror the remote server data to the backup server
2. archive the now local mirror into the dirvish vault

To stick with this scheme, our container shall have
two volumes, one for the mirror and one for the vault.

**Note:** I really should read up on [BackupPC][backuppc],
which seems to be a more modern and more full-featured
backup system for Unix, Mac, Windows.

## Volume Layout

```text
/mirror/                    (where the client mirrors live)
/backup/dirvish/identity           (priv key for rsync/ssh)
/backup/dirvish/master.conf        (copied to /etc/dirvish)
/backup/dirvish/mirror.sh               (pre-server script)
/backup/dirvish/ssmtp.conf           (copied to /etc/ssmtp)
/backup/VAULT/                     (snapshots for a client)
/backup/VAULT/IMAGE/             (archived client snapshot)
/backup/VAULT/dirvish/default.conf          (client config)
/backup/VAULT/dirvish/client             (rsync host:/tree)
/backup/VAULT/dirvish/exclude              (rsync excludes)
```

## Configuration

The only build-time configuration is the `TIMEZONE` build argument
that defaults to `Europe/Zurich` but can be changed like this:
`docker build --build-arg TIMEZONE=Europe/London -t dirvish .`

Container configuration is through files in a mapped volume
and through environment variables and arguments.

Global config:

```text
BACKUP/dirvish/identity            private key for rsync/ssh
BACKUP/dirvish/master.conf         dirvish master config, generated by setup
BACKUP/dirvish/ssmtp.conf          config for ssmtp(8)
BACKUP/dirvish/mirror.sh           invoked by dirvish to mirror a client
```

A key pair will be generated by `setup` if the private key
does not exist. Typically, you place here the private key
and append the corresponding public key (identity.pub) to
the client's */root/.ssh/authorized_keys* file.

For *master.conf* and *ssmtp.conf* consult the dirvish
and ssmtp(8) man pages; *master.conf* can be generated
with the container's `setup` argument. These two files
will be copied to their standard places whenever the
container is called with the `runall` argument.

The *mirror.sh* script may be changed if need be.

Mail notification is only sent if the `MAILTO` env var is
set; to do so, use the `-e MAILTO=root` (or similar)
argument to `docker run`.

Use `-e MAILHUB=mail.example.com` (or similar) to specify
the mail server, and `-e MAILDOMAIN=example.com` (or similar)
to specify where the mail seems to come from. Alternatively,
create an *ssmtp.conf* file in */backup/dirvish/*, which
will take precedence over these environment variables, but
you still have to say `-e MAILTO=user`.

Docker generates host names for its containers. To override,
use the `-h hostname` argument to `docker run`, for example,
`docker run -h $(hostname) ... dirvish ...`.

Per vault config:

```text
BACKUP/VAULT/dirvish/default.conf  generated if missing
BACKUP/VAULT/dirvish/client        clienthost:/clientpath
BACKUP/VAULT/dirvish/exclude       excludes for this vault
```

The *default.conf* will be generated if missing and
its `client: hostname` statement will be updated each
time to reflect the container's hostname (remember
that we first mirror and then do a local dirvish).

The *client* file contains the client address and file system
path to backup. Syntax: `host:/path` on the first (and only)
line of the file. Example: `host.example.com:/data`.

The per-vault *exclude* file contains backup exclusions
for *rsync*.

## Usage

```sh
# Show short help text:
docker run --rm dirvish help

# Generate key pair (if missing) and default configs:
docker run --rm -v /outer/backup:/backup \
  -v /outer/mirror:/mirror dirvish setup

# Create missing initial images:
docker run --rm -v /outer/backup:/backup \
  -v /outer/mirror:/mirror dirvish init

# Backup all vaults (this is the usual case):
docker run --rm -v /outer/backup:/backup \
  -v /outer/mirror:/mirror dirvish runall

# Drop into an interactive shell:
docker run -it --rm -v ... dirvish shell
```

For mail notification, pass the environment variable
`MAILTO=root` (choose recipient) into the container
(and make sure mail is configured -- see above).

You may want to call `runall` nightly from cron.

### Creating an SSH key pair

The container will generate an SSH key pair if none
is found. To provide your own, create the key pair,
place the private key in */backup/dirvish/identity*,
and append the public key to all clients's
*/root/.ssh/authorized_keys* file.

A key pair can be **ssh-keygen**. When called without
arguments, parameters will be queried interactively;
alternatively pass appropriate options. Be sure to
**not** use a passphrase, so that rsync/ssh can use
the key unsupervised.

### Adding a Client

Append the public key */backup/dirvish/identity.pub*
to the client's */root/.ssh/authorized_keys* file.

Within the container, do the following:

```sh
ssh -i /backup/dirvish/identity HOST # test ssh, then exit
mkdir -p /backup/VAULT/dirvish
echo "HOST:/PATH" > /backup/VAULT/dirvish/client
edit /backup/VAULT/dirvish/exclude          # any excludes
/xilab/entry.sh setup          # creates default.conf etc.
dirvish --init --vault VAULT        # create initial image
```

### Removing a Client

To disable backups (but keep config and data):

- remove VAULT's the Runall entry in */backup/dirvish/master.conf*

To delete VAULT's data and config:

- remove VAULT's Runall entry in */backup/dirvish/master.conf*
- delete */mirror/VAULT*
- delete */backup/VAULT*

Both can be done from within the container,
or from the host computer (adjust paths).

## Installing Dirvish

Dirvish comes as a tarball. Once unpacked, it still needs
to be installed. This is done by an interactive script,
*install.sh*, which asks a few parameters (like where
to find perl and where to install), and then concatenates
the final executable scripts from a few pieces.

We want this fully automated and thus provide our own
*setup.sh* script that has our parameter choices hardcoded.

A subtle problem: dirvish creates the index of an image
with `find $destree -ls` but busybox does not support the
`-ls` option. The aforementioned *setup.sh* script substitutes
`-exec ls -dils {} \;` for `-ls`, that is, we direct `find`
to invoke `ls` for each entry. Slow, but works. Alternatively,
we could simply remove the `-ls` option, but doing so would
probably break `dirvish-locate`.

While at it, fix a minor bug in `dirvish-locate`, where
`gzip` is instructed to uncompress file `index` if file
`index.gz` exists.

## Miscellaneous

Note that when writing shell functions, the closing
brace must be on its own line or follow a control operator;
otherwise it is considered another command argument.
This is also true when writing brace groups.

```sh
f() { echo "Correct"; }
g() { echo "Wrong" }  # closing brace is arg to echo
```

An SSH key pair may be created without user interaction
as by the following example. The `-N ''` specifies an
empty passphrase.

```sh
ssh-keygen -t rsa -f /path/to/id_rsa -C root@$(hostname) -N ''
```

The old rsync-dirvish-all script looked similar to the one below:

```sh
LOGFILE="/root/cron/backup/latest.log"
OPTS="-rltH --delete -pgo --stats -D --numeric-ids"
HOST=`/bin/hostname`

# Rotate log files:
test -f "$LOGFILE.3" && rm "$LOGFILE.3"
test -f "$LOGFILE.2" && mv "$LOGFILE.2" "$LOGFILE.3"
test -f "$LOGFILE.1" && mv "$LOGFILE.1" "$LOGFILE.2"
test -f "$LOGFILE"   && mv "$LOGFILE"   "$LOGFILE.1"

# Run all commands in a subshell so we can redirect output easily:
{
echo "** Mirroring seven-partial ..."
rsync $OPTS --exclude-from=/backup/seven-partial/dirvish/exclude \
      seven.xilab.ch:/ /mirror/seven-partial/

echo "** Mirroring lm2 ..."
rsync $OPTS --exclude-from=/backup/lm2/dirvish/exclude \
      lm2.ddns.xilab.ch:/backup/remote/crypt/ /mirror/lm2/

echo "** Archiving mirror states ..."
/usr/sbin/dirvish-runall

echo "** Expiring old images ..."
/usr/sbin/dirvish-expire

echo "** Disk usage report"
df -h / /boot
} 2>&1 | tee "$LOGFILE" | /usr/bin/mail -s "cron@$HOST: $0" root
```

[dirvish]: http://www.dirvish.org/
[backuppc]: https://backuppc.github.io/backuppc/
